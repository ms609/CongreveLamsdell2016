---
title: "Generating data from Congreve & Lamsdell (2016) trees"
author: "Martin R. Smith"
output: html_document
--- 

## Generate MrBayes trees using `bayesgen.pl`

Before running this file, convert MrBayes output into R-readable output in 
nexTrees folder using `t2nex.pl`

## Initialize variables

Before loading trees, R needs to know where abouts on the computer files are stored.

If you are using RStudio, then R will by default begin in the directory
in which the package is installed -- great, no further work is required.

Otherwise you might need to run `setwd("C:/path/to/CongreveLamsdell2016/data-raw")`, 
substituting in the necessary path on your machine.

```{R Initialize-variables}

# Load the tree used to generate the simulated data matrices
referenceTree <- CongreveLamsdell2016::clReferenceTree

# Tree files are located in the data-raw subdirectory
DIR_ROOT = '../data-raw/trees/'
MATRIX_DIR = '../data-raw/matrices'

# The file names have a number of components, whose format is defined here:
FILE_NUMS <- formatC(1:100, width=3, format='d', flag='0') # Add leading zeroes to numbers
SO_NUMS <- formatC(1:20, width=2, format='d', flag='0') # Enumeration of suboptimal trees


# Trees themselves are saved in the data-raw/clTrees subdirectory
TREE_FILE <- paste0(DIR_ROOT, '%s/%s.', FILE_NUMS, '%s.con.nex') # Defines the pattern of the file name
MATRIX_FILES <- paste0(MATRIX_DIR, '/', FILE_NUMS, '.txt.nex')
BAYES_TREE <- paste0(DIR_ROOT, 'MrBayes/%s.nex.run%s.nex')
CI_PATH <- paste0(DIR_ROOT, 'consistency_indices.txt')
BAYES_SUBOPTIMAL <- seq(1, 0.5, length.out = 21)

# Helper function to load suboptimal trees
LoadSuboptimal <- function (pref) {
  lapply(TREE_FILE, function (treeFile) {
    lapply(c(sprintf(treeFile, pref, pref, ''), 
             sprintf(treeFile, pref, pref, paste0('.so', SO_NUMS))),
           ape::read.nexus)
  })
}

# Helper function to load bootstrap and jackknife scores
Resampling <- function (jackFile) {
  jackLines <- readLines(jackFile)
  jackTree <- TreeSearch::TNTText2Tree(jackLines[3])
  jackTipOrder <- order(as.integer(jackTree$tip.label) + 1L)
  jackNodeOrder <- unique(unlist(phangorn::Ancestors(jackTree, jackTipOrder)))[-1]
  nTntNode <- jackTree$Nnode

  treeFile <- gsub("\\.ttag$", ".tre", jackFile)
  tntTrees <- TreeSearch::ReadTntTree(treeFile, relativePath='.')
  tipLabel <- if (class(tntTrees) == 'phylo') tntTrees$tip.label else tntTrees[[1]]$tip.label
  jackTree$tip.label <- tipLabel

  jackScores <- trimws(gsub("ttag \\+\\d+ (.*); *", "\\1",
                            jackLines[length(jackLines) - (nTntNode - 2L):0]))[order(jackNodeOrder)]
  jackScores <- gsub("\\?", 0, jackScores)
  return (list(tree = jackTree,
               sym  = gsub("^(\\d+)/.*", "\\1", jackScores),
               jak  = gsub("^\\d+/(\\[?\\d+\\]?)$", "\\1", jackScores)
               ))
}

```

## Load matrices and calcluate consistency

```{R load-matrices}
rawMatrices <- lapply(MATRIX_FILES, ape::read.nexus.data)
clMatrices <- lapply(rawMatrices, function (mat) lapply(mat, function (row) row[-(56:59)]))
clPhyDat <- lapply(clMatrices, phangorn::phyDat, type="USER", levels=1:2)
clCI <- vapply(clPhyDat, function (mat) phangorn::CI(referenceTree, mat), double(1))
names(clCI) <- FILE_NUMS

# Save data:
usethis::use_data(clMatrices, clPhyDat, clCI, overwrite=TRUE)
```

## Load trees

```{R load-trees}
# For each file, load the MrBayes tree:
for (NUM in FILE_NUMS) {
  if (!file.exists(sprintf(TREE_FILE[as.integer(NUM)], 'mk', 'mk', ''))
      && all(file.exists(sprintf(BAYES_TREE, NUM, 1:4)))) {
    trees <- unlist(lapply(1:4, function (run) {
      ape::read.nexus(file=sprintf(BAYES_TREE, NUM, run))
    }), recursive=FALSE)
    
    class(trees) <- 'multiPhylo'
    consi <- lapply(BAYES_SUBOPTIMAL, function (p) ape::consensus(trees, p=p))
    names(consi) <- paste0('consensus_', BAYES_SUBOPTIMAL)
    ape::write.nexus(rev(consi), file=sprintf(TREE_FILE[as.integer(NUM)], 'mk', 'mk', ''))
  }
}

# Load consensus trees from Equal Weights and Markov model analyses
markov <- lapply(sprintf(TREE_FILE, 'mk', 'mk', ''), ape::read.nexus)
equal <- LoadSuboptimal('eq')
imp1  <- LoadSuboptimal('k1')
imp2  <- LoadSuboptimal('k2')
imp3  <- LoadSuboptimal('k3')
imp5  <- LoadSuboptimal('k5')
impX  <- LoadSuboptimal('kX')
impC  <- lapply(seq_along(imp2), function(i) lapply(1:21, function (j)
  ape::consensus(imp2[[i]][[j]], imp3[[i]][[j]], imp5[[i]][[j]], impX[[i]][[j]])
  ))


```


### Calculate tree statistics (Bremer)

```{R Calculate-statistics}
# Define the expected format of tree statistics (needed for vapply)
# (Using lapply or sapply instead of vapply can be simpler, and is only slightly slower)
BLANK_RETURN <- matrix(0, ncol=6, nrow=21)

clQuartets <- list(
  markov    = vapply(markov, Quartet::QuartetStatus, cf=referenceTree, BLANK_RETURN),
  equal     = vapply(equal,  Quartet::QuartetStatus, cf=referenceTree, BLANK_RETURN),
  implied1  = vapply(imp1,   Quartet::QuartetStatus, cf=referenceTree, BLANK_RETURN),
  implied2  = vapply(imp2,   Quartet::QuartetStatus, cf=referenceTree, BLANK_RETURN),
  implied3  = vapply(imp3,   Quartet::QuartetStatus, cf=referenceTree, BLANK_RETURN),
  implied5  = vapply(imp5,   Quartet::QuartetStatus, cf=referenceTree, BLANK_RETURN),
  implied10 = vapply(impX,   Quartet::QuartetStatus, cf=referenceTree, BLANK_RETURN),
  impliedC  = vapply(impC,   Quartet::QuartetStatus, cf=referenceTree, BLANK_RETURN)
)

clPartitions <- list(
  markov    = vapply(markov, Quartet::SplitStatus, cf=referenceTree, BLANK_RETURN),
  equal     = vapply(equal , Quartet::SplitStatus, cf=referenceTree, BLANK_RETURN),
  implied1  = vapply(imp1,   Quartet::SplitStatus, cf=referenceTree, BLANK_RETURN),
  implied2  = vapply(imp2,   Quartet::SplitStatus, cf=referenceTree, BLANK_RETURN),
  implied3  = vapply(imp3,   Quartet::SplitStatus, cf=referenceTree, BLANK_RETURN),
  implied5  = vapply(imp5,   Quartet::SplitStatus, cf=referenceTree, BLANK_RETURN),
  implied10 = vapply(impX,   Quartet::SplitStatus, cf=referenceTree, BLANK_RETURN),
  impliedC  = vapply(impC,   Quartet::SplitStatus, cf=referenceTree, BLANK_RETURN)
)
```


### Save statistics to data file
This uses the `usedata` package (which you'll need to install using 
`install.packages('usethis')` if you haven't already) to package the data 
into a data file that can be bundled with the package.

```{R Save statistics}
usethis::use_data(clQuartets, clPartitions, overwrite=TRUE)
```

This data is used in `inst/Generate_figures.R` to generate ternary diagrams.

### Calculate tree statistics (resampling)

```{R Load resampling metrics, message=FALSE, warn=FALSE}
jackFile <- "C:/research/iw/Trees/eq.001.ttag"

resamples <- Resampling(jackFile)

# TODO verify that the order is correct
ape::nodelabels(c('', paste0(resamples$sym, '/', resamples$jak)))
ReduceTrees <- function(tree, nodeSupport) {
  nTip <- length(tree$tip.label)
  rootNode <- nTip + 1L
  nNode <- tree$Nnode
  collapseOrder <- order(as.double(nodeSupport))
  nodeOrder <- rootNode + collapseOrder
  nodeChoices <- !upper.tri(matrix(NA, length(nodeOrder), length(nodeOrder)))
  
  # Return:
  apply(nodeChoices, 1, function (i) TreeSearch::CollapseNode(tree, nodeOrder[i]))
}

reduced <- ReduceTrees(resamples$tree, resamples$sym)

```


